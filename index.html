<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Esta meta tag es CLAVE para que los dropdowns se vean negros en navegadores -->
    <meta name="color-scheme" content="dark"> 
    <title>EcoNetwork | App Móvil & Web</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fuentes Google (Poppins) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // Habilitar modo oscuro manual
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        main: '#0f172a',
                        sidebar: '#1e293b',
                        accent: '#10b981',
                        accentGlow: '#34d399',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: #0f172a; /* Fondo base sólido para evitar parpadeos */
            background-image: radial-gradient(circle at top right, #1e293b, #0f172a);
            color: #e2e8f0;
            height: 100dvh; /* Altura dinámica real en móviles */
            display: flex;
            flex-direction: column;
        }

        /* Estilos específicos para inputs y selects */
        .input-eco {
            background-color: #1e293b; /* Color sólido oscuro */
            border: 1px solid #334155;
            color: white;
            font-size: 16px; /* Evita zoom en iPhone */
        }
        .input-eco:focus {
            border-color: #10b981;
            outline: none;
            ring: 2px solid #10b981;
        }

        /* FORZAR COLOR OSCURO EN DROPDOWNS */
        select {
            background-color: #1e293b !important;
            color: white !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* Esto afecta a las opciones desplegadas en Windows/Chrome */
        select option {
            background-color: #1e293b !important;
            color: white !important;
        }

        .glass {
            background: rgba(30, 41, 59, 0.95); /* Menos transparente para mejor lectura */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* Animaciones */
        .slide-down { animation: slideDown 0.3s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); max-height: 0; }
            to { opacity: 1; transform: translateY(0); max-height: 500px; }
        }
        @keyframes slideUp {
            from { opacity: 1; transform: translateY(0); max-height: 500px; }
            to { opacity: 0; transform: translateY(-10px); max-height: 0; }
        }
    </style>
</head>
<body class="md:flex-row overflow-hidden">

    <!-- Notificaciones Toast -->
    <div id="toast-container" class="fixed top-5 right-5 left-5 md:left-auto md:w-auto z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- 1. BARRA DE NAVEGACIÓN MÓVIL (APP BAR) -->
    <nav class="md:hidden glass z-50 flex justify-between items-center p-4 shadow-lg shrink-0 h-16">
        <div class="flex items-center gap-2">
            <i data-lucide="leaf" class="text-accent w-6 h-6"></i>
            <h1 class="text-lg font-bold text-white tracking-tight">EcoNetwork</h1>
        </div>
        <button onclick="toggleMobileMenu()" class="text-accent p-2 hover:bg-white/10 rounded-lg transition-colors">
            <i data-lucide="plus-circle" class="w-7 h-7" id="menuIcon"></i>
        </button>
    </nav>

    <!-- 2. PANEL LATERAL (SIDEBAR PC) / MENÚ DESPLEGABLE (MÓVIL) -->
    <aside id="controlsPanel" class="hidden md:flex flex-col w-full md:w-80 bg-sidebar border-r border-white/5 md:h-full z-40 shadow-2xl absolute md:relative top-16 md:top-0 left-0">
        
        <!-- Header PC -->
        <div class="hidden md:flex p-8 pb-6 border-b border-white/5 justify-between items-center bg-black/20">
            <div>
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-accent to-emerald-300 flex items-center gap-3">
                    <i data-lucide="leaf" class="text-accent"></i> EcoNetwork
                </h1>
                <p class="text-slate-400 text-xs mt-1 uppercase tracking-wide">Gestión Ambiental</p>
            </div>
        </div>

        <!-- Controles (Formulario) -->
        <!-- En móvil tiene padding extra y fondo oscuro para resaltar -->
        <div class="p-6 space-y-5 bg-sidebar md:bg-transparent overflow-y-auto flex-1">
            
            <div class="space-y-4">
                <div class="group relative">
                    <label class="block text-xs font-bold text-accent uppercase mb-2">Seleccionar Equipo</label>
                    <div class="relative">
                        <!-- Select Nativo Estilizado -->
                        <select id="deviceSelect" class="input-eco w-full rounded-xl p-3 pr-10 appearance-none cursor-pointer">
                            <!-- JS llena esto -->
                        </select>
                        <!-- Icono Flecha Personalizado -->
                        <div class="absolute right-3 top-3.5 pointer-events-none text-slate-400">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Cantidad</label>
                        <input type="number" id="qtyInput" placeholder="0" class="input-eco w-full rounded-xl p-3">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Hrs/Día</label>
                        <input type="number" id="hoursInput" placeholder="24" min="0" max="24" class="input-eco w-full rounded-xl p-3">
                    </div>
                </div>

                <button onclick="addItem()" class="w-full py-4 rounded-xl bg-accent text-main font-bold shadow-lg hover:bg-emerald-400 active:scale-95 transition-all flex justify-center items-center gap-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>Añadir a Lista</span>
                </button>

                <div class="flex justify-center pt-2">
                     <button onclick="openModal()" class="text-xs text-slate-400 hover:text-white underline flex items-center gap-1 p-2">
                        + Crear Personalizado
                    </button>
                </div>
            </div>
        </div>

        <!-- Botón Calcular PC (Oculto en móvil aquí, aparece flotante) -->
        <div class="hidden md:block p-6 border-t border-white/5 bg-black/20 backdrop-blur-sm z-10">
            <button onclick="calculateFootprint()" class="w-full py-4 rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                <i data-lucide="cpu" class="w-5 h-5"></i> 
                <span>CALCULAR HUELLA</span>
            </button>
        </div>
    </aside>

    <!-- 3. ÁREA PRINCIPAL (CONTENIDO) -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-gradient-to-br from-main to-slate-900 w-full h-full">
        
        <!-- Header de Lista -->
        <header class="p-5 md:p-8 pb-2 flex justify-between items-end border-b border-white/5 bg-main/50 md:bg-transparent">
            <div>
                <h2 class="text-lg md:text-2xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="list" class="text-slate-400 w-5 h-5"></i>
                    Inventario Actual
                </h2>
            </div>
            <div class="text-xs text-slate-400 font-mono bg-white/5 px-3 py-1 rounded-full">
                <span id="itemCount">0</span> items
            </div>
        </header>

        <!-- Lista Scrollable -->
        <!-- pb-32 en móvil para dejar espacio al botón flotante -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-32 md:pb-8">

            <!-- LISTA DE ITEMS -->
            <div id="inventoryList" class="space-y-3 min-h-[100px]">
                <!-- Estado Vacío -->
                <div class="flex flex-col items-center justify-center h-48 text-slate-600 border-2 border-dashed border-slate-700 rounded-2xl" id="emptyMsg">
                    <i data-lucide="box" class="w-12 h-12 mb-3 opacity-30"></i>
                    <p class="text-sm">Tu lista está vacía.</p>
                    <p class="text-xs mt-1 md:hidden text-accent">Pulsa el botón + arriba para agregar.</p>
                </div>
            </div>

            <!-- SECCIÓN RESULTADOS -->
            <div id="resultsSection" class="hidden space-y-6 animate-fade-in bg-black/20 p-4 md:p-6 rounded-2xl border border-white/5">
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="bar-chart-2" class="text-accent w-6 h-6"></i>
                    <h3 class="text-lg font-bold text-white uppercase tracking-wider">Resultados</h3>
                </div>

                <!-- Tarjetas KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Energía -->
                    <div class="bg-sidebar p-5 rounded-xl border-l-4 border-yellow-500 shadow-lg">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Consumo Anual</p>
                        <div class="text-2xl font-bold text-white" id="totalKwh">0.00 <span class="text-sm font-normal text-slate-500">kWh</span></div>
                    </div>
                    <!-- Huella -->
                    <div class="bg-sidebar p-5 rounded-xl border-l-4 border-accent shadow-lg">
                        <p class="text-[10px] text-accent uppercase font-bold mb-1">Huella CO2 Total</p>
                        <div class="text-3xl font-bold text-white" id="totalCo2">0.00 <span class="text-sm font-normal text-slate-500">kg</span></div>
                    </div>
                    <!-- Fórmula -->
                    <div class="bg-sidebar p-5 rounded-xl border-l-4 border-blue-500 flex items-center">
                         <div class="text-xs font-mono text-slate-300">
                            E = (W × H × 365) / 1000 <br>
                            <span class="text-slate-500">Factor Emisión: 0.45</span>
                         </div>
                    </div>
                </div>

                <!-- Gráfica y Recomendaciones -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-sidebar p-4 rounded-xl border border-white/5 h-60">
                        <canvas id="emissionsChart"></canvas>
                    </div>
                    <div id="recommendationBox" class="bg-sidebar p-4 rounded-xl border border-white/5 text-sm">
                        <!-- JS content -->
                    </div>
                </div>
            </div>

            <div class="h-10 md:hidden"></div> <!-- Espaciador final móvil -->
        </div>
    </main>

    <!-- BOTÓN FLOTANTE CALCULAR (SOLO MÓVIL) -->
    <div class="md:hidden fixed bottom-6 left-6 right-6 z-30">
        <button onclick="calculateFootprint()" class="w-full py-4 rounded-full bg-gradient-to-r from-accent to-emerald-600 text-main font-bold shadow-2xl shadow-emerald-900/50 flex justify-center items-center gap-2 active:scale-95 transition-transform border border-white/20">
            <i data-lucide="calculator" class="w-5 h-5"></i>
            CALCULAR AHORA
        </button>
    </div>

    <!-- OVERLAY OSCURO PARA MÓVIL -->
    <div id="mobileOverlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/80 z-30 hidden backdrop-blur-sm md:hidden"></div>

    <!-- MODAL NUEVO PRODUCTO -->
    <div id="productModal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden flex justify-center items-center z-[60] p-4">
        <div class="bg-sidebar w-full max-w-sm rounded-2xl p-6 border border-white/10 shadow-2xl transform scale-95 transition-all" id="modalContent">
            <h3 class="text-lg font-bold text-white mb-4">Nuevo Dispositivo</h3>
            <div class="space-y-3">
                <input type="text" id="newProdName" placeholder="Nombre" class="input-eco w-full rounded-lg p-3">
                <input type="number" id="newProdWatts" placeholder="Watts" class="input-eco w-full rounded-lg p-3">
                <input type="number" id="newProdFab" placeholder="Huella Fab. (Opcional)" class="input-eco w-full rounded-lg p-3">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 rounded-lg border border-white/10 text-slate-300">Cancelar</button>
                <button onclick="saveNewProduct()" class="flex-1 py-3 rounded-lg bg-accent text-main font-bold">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- LÓGICA MÓVIL ---
        function toggleMobileMenu() {
            const panel = document.getElementById('controlsPanel');
            const overlay = document.getElementById('mobileOverlay');
            const icon = document.getElementById('menuIcon');

            if (panel.classList.contains('hidden')) {
                // Abrir menú
                panel.classList.remove('hidden');
                panel.classList.add('flex', 'absolute', 'top-16', 'left-0', 'w-full', 'h-auto', 'border-b', 'border-white/10', 'animate-fade-in');
                overlay.classList.remove('hidden');
                icon.setAttribute('data-lucide', 'x');
            } else {
                // Cerrar menú
                panel.classList.add('hidden');
                panel.classList.remove('flex', 'absolute');
                overlay.classList.add('hidden');
                icon.setAttribute('data-lucide', 'plus-circle');
            }
            lucide.createIcons();
        }

        // --- TOASTS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bg = type === 'error' ? 'bg-red-900/90 border-red-500' : 'bg-emerald-900/90 border-accent';
            
            toast.className = `pointer-events-auto p-4 rounded-xl border-l-4 shadow-xl text-white text-sm font-medium flex items-center gap-3 transform transition-all duration-300 translate-x-full ${bg}`;
            toast.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(toast);
            
            // Animación entrada
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));

            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- LÓGICA APP ---
        const catalog = {
            "Switch Cisco (24/48 puertos)": { watts: 50, fab_co2: 80 },
            "Router Cisco ISR": { watts: 40, fab_co2: 60 },
            "Antena Ubiquiti LiteBeam": { watts: 7, fab_co2: 15 },
            "Antena Ubiquiti NanoStation": { watts: 8, fab_co2: 18 },
            "PC Escritorio (Promedio)": { watts: 200, fab_co2: 250 },
            "Laptop Corporativa": { watts: 65, fab_co2: 180 },
            "Monitor LED 24 Pulgadas": { watts: 25, fab_co2: 120 },
            "Servidor Rack (1U)": { watts: 350, fab_co2: 600 },
            "Access Point WiFi 6": { watts: 12, fab_co2: 25 },
            "Impresora Laser Red": { watts: 400, fab_co2: 150 },
            "Teléfono VoIP": { watts: 5, fab_co2: 10 },
            "Cámara de Seguridad IP": { watts: 6, fab_co2: 12 },
            "Cable UTP Cat6 (por metro)": { watts: 0, fab_co2: 0.2 }
        };

        let inventory = [];
        let myChart = null;
        const FACTOR_EMISION = 0.45;

        function init() {
            populateSelect();
        }

        function populateSelect() {
            const select = document.getElementById('deviceSelect');
            select.innerHTML = '';
            Object.keys(catalog).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }

        function addItem() {
            const name = document.getElementById('deviceSelect').value;
            const qty = parseInt(document.getElementById('qtyInput').value);
            const hours = parseFloat(document.getElementById('hoursInput').value);

            if (!qty || qty <= 0) return showToast("Cantidad inválida", "error");
            if (isNaN(hours) || hours < 0 || hours > 24) return showToast("Horas inválidas (0-24)", "error");

            const techData = catalog[name];
            inventory.push({
                id: Date.now(),
                name, qty, hours, ...techData
            });

            renderInventory();
            showToast("Agregado correctamente");
            
            // En móvil, cerrar menú al agregar para ver la lista
            if(window.innerWidth < 768) toggleMobileMenu();

            // Limpiar inputs
            document.getElementById('qtyInput').value = '';
            document.getElementById('hoursInput').value = '';
        }

        function renderInventory() {
            const list = document.getElementById('inventoryList');
            const emptyMsg = document.getElementById('emptyMsg');
            document.getElementById('itemCount').innerText = inventory.length;

            // Limpiar todo menos el msg vacío
            Array.from(list.children).forEach(child => {
                if (child.id !== 'emptyMsg') child.remove();
            });

            if (inventory.length === 0) {
                emptyMsg.style.display = 'flex';
            } else {
                emptyMsg.style.display = 'none';
                inventory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = "bg-sidebar p-4 rounded-xl border border-white/5 flex justify-between items-center shadow-sm animate-slide-in";
                    el.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 rounded-full bg-accent/10 flex items-center justify-center text-accent shrink-0">
                                <i data-lucide="package" class="w-5 h-5"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-white text-sm truncate">${item.name}</h4>
                                <div class="text-xs text-slate-400 flex gap-2">
                                    <span>x${item.qty}</span> • <span>${item.hours}h/día</span> • <span>${item.watts}W</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="removeItem(${item.id})" class="text-red-400 p-2 hover:bg-red-400/10 rounded-lg">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    list.appendChild(el);
                });
                lucide.createIcons();
            }
        }

        function removeItem(id) {
            inventory = inventory.filter(i => i.id !== id);
            renderInventory();
            if (inventory.length === 0) document.getElementById('resultsSection').classList.add('hidden');
        }

        function calculateFootprint() {
            if (inventory.length === 0) return showToast("Lista vacía", "error");

            let totalKwh = 0;
            let totalFabCo2 = 0;
            const labels = [];
            const data = [];

            inventory.forEach(item => {
                const daily = item.watts * item.qty * item.hours;
                const annual = (daily * 365) / 1000;
                totalKwh += annual;

                const fab = (item.fab_co2 * item.qty) / 5;
                totalFabCo2 += fab;

                const itemTotal = (annual * FACTOR_EMISION) + fab;
                labels.push(item.name.substring(0, 10) + '..');
                data.push(itemTotal);
            });

            const totalFootprint = (totalKwh * FACTOR_EMISION) + totalFabCo2;

            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Animación números
            document.getElementById('totalKwh').innerText = totalKwh.toLocaleString('es-MX', {maximumFractionDigits:2});
            document.getElementById('totalCo2').innerText = totalFootprint.toLocaleString('es-MX', {maximumFractionDigits:2});

            // Scroll al resultado
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

            // Recomendaciones
            const box = document.getElementById('recommendationBox');
            if(totalFootprint > 1000) {
                box.innerHTML = `<strong class="text-red-400 block mb-2">⚠️ ALTO IMPACTO</strong>Reduce consumo o actualiza hardware.`;
                box.className = "bg-red-900/20 p-4 rounded-xl border border-red-500 text-sm";
            } else {
                box.innerHTML = `<strong class="text-accent block mb-2">✅ BUEN ESTADO</strong>Tu red es eficiente.`;
                box.className = "bg-emerald-900/20 p-4 rounded-xl border border-accent text-sm";
            }

            // Gráfica
            const ctx = document.getElementById('emissionsChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'kg CO2',
                        data,
                        backgroundColor: '#10b981',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { display: false }
                    }
                }
            });

            if(totalFootprint < 500) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // Modales
        function openModal() { document.getElementById('productModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('productModal').classList.add('hidden'); }
        
        function saveNewProduct() {
            const name = document.getElementById('newProdName').value;
            const w = document.getElementById('newProdWatts').value;
            const fab = document.getElementById('newProdFab').value;
            
            if(!name || !w) return showToast("Faltan datos", "error");
            
            catalog[name] = { watts: parseFloat(w), fab_co2: parseFloat(fab) || 0 };
            populateSelect();
            document.getElementById('deviceSelect').value = name;
            closeModal();
            showToast("Producto Creado");
        }

        init();
    </script>
</body>
</html>